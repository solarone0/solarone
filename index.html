<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Vision Tracker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Core Libraries: React and ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- UI Libraries that depend on React -->
  <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide-react.js"></script>
  
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="데일리 루틴 · 메모 · 장기 비전 진행률 트래커" />
  <style>
    /* Basic styling for better mobile experience */
    * { -webkit-tap-highlight-color: transparent; }
    html, body, #root { height: 100%; }
    /* Simple animation for modal */
    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
    .modal-exit { opacity: 1; transform: scale(1); }
    .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
  <div id="root" class="h-full"></div>

  <!-- Application logic script -->
  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState, useCallback, Fragment } = React;
    // Lucide icons are available on the global `lucide` object
    const { X, Plus, Edit, Trash2, Check, ChevronDown, Calendar, Target, Repeat, Book, BarChart2, AlertTriangle } = lucide;

    /***********************************
     * Utils
     ***********************************/
    const uid = () => Math.random().toString(36).slice(2, 10);
    const todayStr = (d = new Date()) => d.toISOString().slice(0, 10); // YYYY-MM-DD
    const weekday = (d = new Date()) => d.getDay(); // 0~6 (Sun~Sat)
    const WEEKDAYS = ['일', '월', '화', '수', '목', '금', '토'];
    const clamp = (v, min = 0, max = 100) => Math.min(max, Math.max(min, v));
    const formatDateK = (iso) => {
      try {
        const d = new Date(iso);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      } catch (e) {
        return iso; 
      }
    };

    /***********************************
     * Local Storage (for data persistence)
     ***********************************/
    const STORAGE_KEY = 'dvt_v2_state';
    const loadState = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (error) {
        console.error("Failed to load state from localStorage", error);
        return null;
      }
    };
    const saveState = (state) => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (error) {
        console.error("Failed to save state to localStorage", error);
      }
    };

    /***********************************
     * Default State Structure
     ***********************************/
    const defaultState = {
      routines: [],
      checkins: {},
      notes: {},
      goals: [],
      createdAt: todayStr(),
    };

    /***********************************
     * Progress Calculation Helpers
     ***********************************/
    function isRoutineScheduledToday(routine, date = new Date()) {
      if (!routine || !routine.schedule) return true;
      const w = weekday(date);
      if (routine.schedule.type === 'days') {
        return routine.schedule.days && routine.schedule.days.includes(w);
      }
      if (routine.schedule.type === 'perWeek') return true;
      return true;
    }

    function startOfWeek(d) {
      const x = new Date(d);
      const day = x.getDay();
      const diff = x.getDate() - day + (day === 0 ? -6 : 1); // Adjust to make Monday the start
      return new Date(x.setDate(diff));
    }

    function getRoutineWeeklyCompletion(state, routineId, endDate = new Date(), weeks = 4) {
      const r = state.routines.find(function(r) { return r.id === routineId });
      if (!r) return 0;

      let totalPercentage = 0;
      for (let i = 0; i < weeks; i++) {
        const weekEndDate = new Date(endDate);
        weekEndDate.setDate(weekEndDate.getDate() - (i * 7));
        const weekStartDate = startOfWeek(weekEndDate);

        let planned = 0;
        let done = 0;
        
        if (r.schedule && r.schedule.type === 'days') {
          for (let d = new Date(weekStartDate); d <= weekEndDate; d.setDate(d.getDate() + 1)) {
            if (r.schedule.days && r.schedule.days.includes(weekday(d))) {
              planned++;
              const iso = todayStr(d);
              if (state.checkins[iso] && state.checkins[iso][r.id]) {
                done++;
              }
            }
          }
        } else if (r.schedule && r.schedule.type === 'perWeek') {
          planned = r.schedule.perWeek || 0;
          for (let d = new Date(weekStartDate); d <= weekEndDate; d.setDate(d.getDate() + 1)) {
            const iso = todayStr(d);
            if (state.checkins[iso] && state.checkins[iso][r.id]) {
              done++;
            }
          }
        } else { // No schedule
          planned = 7; // Assume daily
          for (let d = new Date(weekStartDate); d <= weekEndDate; d.setDate(d.getDate() + 1)) {
            const iso = todayStr(d);
            if (state.checkins[iso] && state.checkins[iso][r.id]) {
              done++;
            }
          }
        }
        const weekPercentage = planned > 0 ? (done / planned) * 100 : (done > 0 ? 100 : 0);
        totalPercentage += weekPercentage;
      }

      return clamp(totalPercentage / weeks);
    }

    function computeGoalProgress(state, goal) {
      if (!goal || !goal.milestones || !goal.milestones.length) return 0;
      let totalWeight = 0, weightedProgress = 0;
      for (const m of goal.milestones) {
        const weight = clamp(m.weight || 0, 0, 100);
        totalWeight += weight;
        let progress = 0;
        if (m.type === 'linked' && m.routineId) {
          progress = getRoutineWeeklyCompletion(state, m.routineId, new Date(), 4);
        } else {
          progress = clamp(m.progress || 0, 0, 100);
        }
        weightedProgress += weight * (progress / 100);
      }
      if (totalWeight === 0) return 0;
      return clamp((weightedProgress / totalWeight) * 100);
    }

    /***********************************
     * Common UI Components
     ***********************************/
    const Card = ({ children, className = '' }) => <div className={`rounded-2xl bg-white shadow-sm ring-1 ring-slate-200/50 ${className}`}>{children}</div>;
    const CardHeader = ({ title, children, className = '' }) => (
      <div className={`flex items-center justify-between border-b border-slate-100 px-4 py-3 ${className}`}>
        <h3 className="font-semibold text-slate-800 text-lg">{title}</h3>
        <div>{children}</div>
      </div>
    );
    const CardBody = ({ children, className = '' }) => <div className={`p-4 ${className}`}>{children}</div>;
    const Button = ({ children, onClick, className = '', type = 'button', Icon, disabled=false }) => (
      <button type={type} onClick={onClick} disabled={disabled} className={`active:scale-[.98] disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold bg-sky-600 text-white hover:bg-sky-700 transition-colors ${className}`}>
        {Icon && <Icon size={16} />}
        {children}
      </button>
    );
    const GhostBtn = ({ children, onClick, className = '', type = 'button', Icon, disabled=false }) => (
      <button type={type} onClick={onClick} disabled={disabled} className={`active:scale-[.98] disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm font-medium bg-transparent text-slate-600 hover:bg-slate-100 transition-colors ${className}`}>
        {Icon && <Icon size={16} />}
        {children}
      </button>
    );
    const Input = React.forwardRef((props, ref) => <input ref={ref} {...props} className={`w-full rounded-xl border px-3 py-2 text-sm border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-400 transition ${props.className || ''}`} />);
    const Textarea = React.forwardRef((props, ref) => <textarea ref={ref} {...props} className={`w-full rounded-xl border px-3 py-2 text-sm border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-400 transition ${props.className || ''}`}></textarea>);
    const Select = React.forwardRef((props, ref) => <select ref={ref} {...props} className={`w-full rounded-xl border px-3 py-2 text-sm border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white appearance-none ${props.className || ''}`}></select>);
    const Progress = ({ value }) => (
      <div className="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
        <div className="h-full bg-sky-500 transition-all duration-300" style={{ width: `${clamp(value)}%` }}></div>
      </div>
    );
    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-xl w-full max-w-md modal-enter-active" onClick={function(e) { e.stopPropagation() }}>
            <header className="flex items-center justify-between p-4 border-b border-slate-200">
              <h2 className="text-lg font-bold">{title}</h2>
              <GhostBtn onClick={onClose} Icon={X} className="!p-2" />
            </header>
            <div className="p-4">{children}</div>
          </div>
        </div>
      );
    };

    const ConfirmationModal = ({ modalConfig, onConfirm, onCancel }) => {
        if (!modalConfig.isOpen) return null;
        return (
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm modal-enter-active p-6 text-center" onClick={function(e) { e.stopPropagation() }}>
                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <AlertTriangle className="h-6 w-6 text-red-600" />
                    </div>
                    <h3 className="text-lg font-semibold mt-4 text-slate-800">{modalConfig.title}</h3>
                    <p className="text-sm text-slate-500 mt-2">{modalConfig.message}</p>
                    <div className="mt-6 flex justify-center gap-3">
                        <GhostBtn onClick={onCancel} className="flex-1 justify-center">취소</GhostBtn>
                        <Button onClick={onConfirm} className="flex-1 justify-center bg-red-600 hover:bg-red-700">확인</Button>
                    </div>
                </div>
            </div>
        );
    };

    /***********************************
     * Forms
     ***********************************/
    const RoutineForm = ({ routine, onSave, onCancel }) => {
        const [title, setTitle] = useState(routine ? routine.title : '');
        const [color, setColor] = useState(routine ? routine.color : '#38bdf8');
        const [scheduleType, setScheduleType] = useState((routine && routine.schedule) ? routine.schedule.type : 'days');
        const [days, setDays] = useState((routine && routine.schedule && routine.schedule.days) ? routine.schedule.days : [1, 2, 3, 4, 5]);
        const [perWeek, setPerWeek] = useState((routine && routine.schedule && routine.schedule.perWeek) ? routine.schedule.perWeek : 3);

        const handleDayToggle = (day) => {
            setDays(function(prev) { return prev.includes(day) ? prev.filter(function(d) { return d !== day }) : [...prev, day].sort() });
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!title) return;
            const schedule = scheduleType === 'days' ? { type: 'days', days: days } : { type: 'perWeek', perWeek: Number(perWeek) };
            onSave({ id: routine ? routine.id : undefined, title: title, color: color, schedule: schedule });
        };

        return (
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label className="text-sm font-medium text-slate-700">루틴 이름</label>
                    <Input type="text" value={title} onChange={function(e) { setTitle(e.target.value) }} placeholder="예: 아침 조깅" required />
                </div>
                <div>
                    <label className="text-sm font-medium text-slate-700">색상</label>
                    <div className="flex items-center gap-2">
                        <input type="color" value={color} onChange={function(e) { setColor(e.target.value) }} className="w-10 h-10 rounded-lg p-1 border border-slate-300" />
                        <Input type="text" value={color} onChange={function(e) { setColor(e.target.value) }} />
                    </div>
                </div>
                <div>
                    <label className="text-sm font-medium text-slate-700">스케줄</label>
                    <Select value={scheduleType} onChange={function(e) { setScheduleType(e.target.value) }}>
                        <option value="days">요일 지정</option>
                        <option value="perWeek">주 N회</option>
                    </Select>
                </div>
                {scheduleType === 'days' && (
                    <div>
                        <div className="grid grid-cols-7 gap-2">
                            {WEEKDAYS.map(function(label, index) { return (
                                <button type="button" key={index} onClick={function() { handleDayToggle(index) }} className={`p-2 rounded-lg text-sm border ${days.includes(index) ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-slate-700 border-slate-300'}`}>
                                    {label}
                                </button>
                            )})}
                        </div>
                    </div>
                )}
                {scheduleType === 'perWeek' && (
                    <div>
                        <label className="text-sm font-medium text-slate-700">주당 횟수</label>
                        <Input type="number" value={perWeek} onChange={function(e) { setPerWeek(e.target.value) }} min="1" max="7" />
                    </div>
                )}
                <div className="flex justify-end gap-2 pt-4">
                    <GhostBtn onClick={onCancel}>취소</GhostBtn>
                    <Button type="submit">{routine ? '저장' : '추가'}</Button>
                </div>
            </form>
        );
    };

    /***********************************
     * Main App
     ***********************************/
    function App() {
      // App data state
      const [state, setState] = useState(() => loadState() || defaultState);

      // UI state
      const [tab, setTab] = useState('today');
      const [date, setDate] = useState(todayStr());
      const [modal, setModal] = useState({ isOpen: false, type: null, data: null });
      const [confirmModal, setConfirmModal] = useState({ isOpen: false, onConfirm: function() {}, title: '', message: '' });

      // Persist state to localStorage on change
      useEffect(() => {
        saveState(state);
      }, [state]);

      // Memos for derived state
      const todayCheckins = useMemo(() => (state.checkins && state.checkins[date]) || {}, [state.checkins, date]);
      const scheduledRoutines = useMemo(() => state.routines.filter(function(r) { return isRoutineScheduledToday(r, new Date(date)) }), [state.routines, date]);
      const todaysProgress = useMemo(() => {
        if (!scheduledRoutines.length) return 0;
        const done = scheduledRoutines.filter(function(r) { return todayCheckins[r.id] }).length;
        return Math.round(done / scheduledRoutines.length * 100);
      }, [scheduledRoutines, todayCheckins]);
      const goalsWithProgress = useMemo(() => state.goals.map(function(g) { return { ...g, _progress: Math.round(computeGoalProgress(state, g)) } }), [state]);

      // Actions (state updates)
      const toggleCheckin = (rid) => {
        setState(function(prev) {
          const day = (prev.checkins && prev.checkins[date]) ? {...prev.checkins[date]} : {};
          day[rid] = !day[rid];
          const newCheckins = { ...(prev.checkins || {}), [date]: day };
          return { ...prev, checkins: newCheckins };
        });
      };
      
      const setNote = (text) => {
        setState(function(prev) {
          const newNotes = { ...(prev.notes || {}), [date]: text };
          return { ...prev, notes: newNotes };
        });
      };

      const upsertRoutine = (draft) => {
        setState(function(prev) {
          if (draft.id) {
            return { ...prev, routines: prev.routines.map(function(r) { return r.id === draft.id ? {...r, ...draft} : r }) };
          } else {
            const newRoutine = { ...draft, id: uid(), createdAt: todayStr() };
            return { ...prev, routines: [...prev.routines, newRoutine] };
          }
        });
        closeModal();
      };
      
      const handleDeleteRoutine = (rid) => {
        showConfirm(
          '루틴 삭제',
          '정말로 이 루틴을 삭제하시겠습니까?',
          function() {
            setState(function(prev) {
              return {
                ...prev,
                routines: prev.routines.filter(function(r) { return r.id !== rid })
              };
            });
          }
        );
      };

      // Modal handlers
      const openModal = (type, data = null) => setModal({ isOpen: true, type: type, data: data });
      const closeModal = () => setModal({ isOpen: false, type: null, data: null });
      const showConfirm = (title, message, onConfirm) => setConfirmModal({ isOpen: true, title: title, message: message, onConfirm: onConfirm });
      const closeConfirm = () => setConfirmModal({ isOpen: false, title: '', message: '', onConfirm: function() {} });

      const handleConfirm = () => {
        if (confirmModal.onConfirm) {
          confirmModal.onConfirm();
        }
        closeConfirm();
      };

      const renderModalContent = () => {
        switch (modal.type) {
          case 'routine':
            return <RoutineForm routine={modal.data} onSave={upsertRoutine} onCancel={closeModal} />;
          default:
            return null;
        }
      };

      return (
        <div className="mx-auto max-w-3xl h-full flex flex-col">
          <Modal isOpen={modal.isOpen} onClose={closeModal} title={modal.type === 'routine' ? (modal.data ? '루틴 편집' : '새 루틴 추가') : ''}>
            {renderModalContent()}
          </Modal>
          <ConfirmationModal modalConfig={confirmModal} onConfirm={handleConfirm} onCancel={closeConfirm} />

          <header className="sticky top-0 z-10 bg-slate-50/80 backdrop-blur border-b border-slate-200">
            <div className="px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-2xl bg-sky-500 grid place-items-center text-white font-bold text-xl">D</div>
                <div>
                  <div className="text-sm text-slate-500">Daily Vision Tracker</div>
                  <div className="font-semibold">오늘을 쌓아 비전으로</div>
                </div>
              </div>
            </div>
            <nav className="px-2 pb-2 grid grid-cols-4 gap-2">
              {[
                { id: 'today', label: '오늘', Icon: Calendar },
                { id: 'routines', label: '루틴', Icon: Repeat },
                { id: 'goals', label: '비전', Icon: Target },
                { id: 'report', label: '리포트', Icon: BarChart2 },
              ].map(function(t) { return (
                <button key={t.id} onClick={function() { setTab(t.id) }} className={`flex items-center justify-center gap-2 rounded-xl px-3 py-2.5 text-sm font-semibold transition-colors ${tab === t.id ? 'bg-sky-600 text-white' : 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-100'}`}>
                  <t.Icon size={16} />
                  <span>{t.label}</span>
                </button>
              )}) }
            </nav>
          </header>

          <main className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-100/50">
            {tab === 'today' && (
              <Fragment>
                <Card>
                  <CardHeader title="오늘 루틴">
                    <input type="date" value={date} onChange={function(e) { setDate(e.target.value) }} className="rounded-xl border px-3 py-1.5 text-sm border-slate-300 bg-white" />
                  </CardHeader>
                  <CardBody>
                    {scheduledRoutines.length === 0 ? (
                      <div className="text-slate-500 text-center py-8">오늘 예정된 루틴이 없습니다.</div>
                    ) : (
                      <ul className="space-y-3">
                        {scheduledRoutines.map(function(r) { return (
                          <li key={r.id} className="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 transition-colors">
                            <input id={`r-${r.id}`} type="checkbox" checked={!!todayCheckins[r.id]} onChange={function() { toggleCheckin(r.id) }} className="h-6 w-6 rounded-md border-slate-300 text-sky-600 focus:ring-sky-500" />
                            <label htmlFor={`r-${r.id}`} className="flex-1 cursor-pointer">
                              <div className="font-medium text-slate-800">{r.title}</div>
                            </label>
                            <span className="w-4 h-4 rounded-full" style={{ background: r.color || '#38bdf8' }}></span>
                            <GhostBtn Icon={Edit} onClick={function() { openModal('routine', r) }} className="text-slate-400 hover:text-sky-600" />
                            <GhostBtn Icon={Trash2} onClick={function() { handleDeleteRoutine(r.id) }} className="text-slate-400 hover:text-red-600" />
                          </li>
                        )})}
                      </ul>
                    )}
                    <div className="mt-6 flex items-center justify-between">
                      <div className="flex-1 mr-4">
                        <div className="flex justify-between mb-1">
                            <span className="text-sm font-medium text-slate-600">오늘 진행률</span>
                            <span className="text-sm font-bold text-sky-600">{todaysProgress}%</span>
                        </div>
                        <Progress value={todaysProgress} />
                      </div>
                      <Button Icon={Plus} onClick={function() { openModal('routine') }}>루틴 추가</Button>
                    </div>
                  </CardBody>
                </Card>
                <Card>
                  <CardHeader title="오늘 메모" />
                  <CardBody>
                    <Textarea rows={5} placeholder="오늘의 생각이나 기록을 남겨보세요..." value={(state.notes && state.notes[date]) || ''} onChange={function(e) { setNote(e.target.value) }} />
                  </CardBody>
                </Card>
              </Fragment>
            )}
             {tab==='routines' && (
                <Card>
                  <CardHeader title="전체 루틴 목록">
                    <Button Icon={Plus} onClick={function() { openModal('routine') }}>새 루틴 추가</Button>
                  </CardHeader>
                  <CardBody>
                    {state.routines.length === 0 ? (
                      <div className="text-center py-10 text-slate-500">루틴이 없습니다.</div>
                    ) : (
                      <ul className="space-y-2">
                        {state.routines.map(function(r) { return (
                           <li key={r.id} className="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
                            <span className="w-4 h-4 rounded-full" style={{ background: r.color || '#38bdf8' }}></span>
                            <div className="flex-1">
                              <p className="font-semibold">{r.title}</p>
                              <p className="text-xs text-slate-500">
                                {(r.schedule && r.schedule.type === 'days') ? `매주 ${r.schedule.days.map(function(d) { return WEEKDAYS[d] }).join(', ')}` : `주 ${r.schedule.perWeek}회`}
                              </p>
                            </div>
                            <GhostBtn Icon={Edit} onClick={function() { openModal('routine', r) }}>편집</GhostBtn>
                            <GhostBtn Icon={Trash2} onClick={function() { handleDeleteRoutine(r.id) }} className="hover:text-red-500">삭제</GhostBtn>
                          </li>
                        )})}
                      </ul>
                    )}
                  </CardBody>
                </Card>
             )}
              {tab==='goals' && <div className="text-center text-slate-500 py-10">목표/비전 기능은 준비 중입니다.</div>}
              {tab==='report' && <div className="text-center text-slate-500 py-10">리포트 기능은 준비 중입니다.</div>}
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <!-- Babel for JSX transpilation - MOVED TO THE END -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</body>
</html>
